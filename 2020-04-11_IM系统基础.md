### IM系统结构












## 消息及时性

### 短链接

- Http轮询

### 长连接

- 协议

	- Http长连接

	- web socket

	- 开源消息协议

	- 私有消息协议

- 维护数据

	- app 版本号/操作系统网络状态

	- 用户设备与网络连接映射

	- 用户在线状态

	- 所有在线设备

- 心跳检测

	- 原因

		- TCP对物理链路断开无感知

	- 必要性

		- 降低服务端连接维护的开销

		- 支撑客户端的断开重连，保障长连接可用性

		- 避免NAT映射表被清除

	- 实现

		- TCP Keepalive

			- 配置

				- 心跳周期

				- 重试次数

				- 超时时间

			- 优缺点

				- 易用性好

				- 网络消耗小

				- 固定间隔不灵活

				- 表示连接层探活，非应用层

		- 应用层心跳

			- 本质

				- 客户端每隔一定时间间隔，向 IM 服务端发送一个业务层的数据包告知自身存活

			- 优点

				- 灵活设置超时时间

				- 保障应用层存活

## 消息可靠性

### 发送丢失

- 客户端重传

	- 服务端去重

### 接受丢失

- 客户端

	- ack确认

	- 重传消息去重(MessageID)

- 服务端

	- 等待 ack 队列

	- 超时ack重传

	- 兜底完整性检查(重传失效情况 )

		- 时间戳对比

## 消息时序一致性

### 难点

- 多发送方

- 多接收方

- 并发

### 全局序号生成器（时序基准）

- redis单机点

	- 可用性不高，准确性高

- snowflake分布式算法

	- 可用性高，准确性不高（秒/毫秒）

- 数据库自增主键

	- 可用性不高，准确性高

- 妥协

	- 不需要绝对精确，在用户可接受范围内即可

	- 不需要全局有序，只要求范围有序

### 消息绝对有序性

- 发送方乱序

	- 服务端消息整流

- 接收方乱序

	- 客服端消息整流

## 消息安全性

### 传输安全性

- 访问入口安全

	- DNS解析问题

		- 原因

			- 路由器设置

			- 运营商篡改

			- 运营商缓存

			- 运营商转发解析

			- NAT地址转换

			- 运营商域名更新忽略TTL

		- 解决方案

			- HttpDNS

				- 原理

					- 基于http实现DNS协议，绕过运营商劫持

				- 功能

					- DNS解析

					- 智能调度

					- 健康检查

				- 更新方式

					- 同步更新

						- 读取缓存，若缓存失效则发送请求

					- 异步更新

						- 读取缓存，失效缓存，异步发送请求更新缓存

- 传输链路安全

	- 危害

		- 中断

		- 窃听

		- 篡改

		- 伪造

	- 解决方案

		- 中断

			- 多通道方式

				- ip切换

				- 协议切换

		- 窃听、篡改、伪造

			- 私有协议

			- TLS

### 存储安全性

- 账号密码

	- 高强度单向散列算法

	- 每个账号独享的“盐”

	- 存储分离

	- DB 访问权限

	- 网络隔离

- 内容安全

	- 识别

		- 敏感词库

		- 图片识别

		- 语音转文字和 OCR

		- 爬虫技术来对链接内容分析

	- 惩罚

		- 禁言

		- 解散群

- 存储安全

	- 端到端加密

		- 中间任何链路环节都不对消息进行解密

		- 消息内容不在服务端存储

